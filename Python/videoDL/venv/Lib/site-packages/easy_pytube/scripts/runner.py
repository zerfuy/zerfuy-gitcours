# -*- coding: utf-8 -*-


import configparser
import random
import string
from multiprocessing import Process

import ffmpeg
from moviepy.editor import *
from pytube import YouTube


def dodownload(url, start, end):
    # move to current dir to access ffmpeg executable and config file
    os.chdir(os.path.dirname(__file__))

    # get default path from conf file
    config = configparser.ConfigParser()
    filename = os.path.join('..', 'config', 'conf.ini')
    config.read(filename)

    # pick highest stream quality available
    yt = YouTube(url)
    in_file = ffmpeg.input(yt.streams.filter(progressive=True, file_extension='mp4').order_by('resolution')[-1].url)

    # define path and ensure name doesn't already exist
    path = config['config']['default_dir'] + "\\" + '' \
        .join(random.choices(string.ascii_uppercase + string.digits, k=10))
    while os.path.exists(path):
        path = config['config']['default_dir'] + "\\" + '' \
            .join(random.choices(string.ascii_uppercase + string.digits, k=10))

    # get portion of video and cut duplicated frames out
    in_file.trim(start=int(start), end=int(end)).output(path + ".mp4").run()
    clip = VideoFileClip(path + ".mp4").subclip(int(start), int(end))
    clip.write_videofile(path + "cut.mp4")

    # remove the useless video
    # os.remove(path + ".mp4")


def run():
    # (really) quick explanation.
    print("____________________________START____________________________")
    print("how to use :")
    print("first arg : video url at time t.")
    print("second arg : record duration.")

    # get url, start and end. Correct arg usage is expected.
    url = input("url : ").split("?t=")
    url, start = url[0], int(url[1])
    end = int(start) + int(input("len : "))

    Process(target=dodownload, args=(url, start, end,)).start()

    print("\n\n\n")


if __name__ == "__main__":
    run()
